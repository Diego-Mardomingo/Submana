---
import "@fontsource-variable/inter";
import { Toaster } from "@pheralb/toast";
import { ClientRouter } from "astro:transitions";
import Navigation from "../components/Navigation.astro";
import { getLangFromCookie, useTranslations } from "../i18n/utils";

interface Props {
  title: string;
}

const { title } = Astro.props;
const lang = getLangFromCookie(Astro.cookies);
const t = useTranslations(lang);
const theme = Astro.cookies.get("submana-theme")?.value || "dark";

// Format title: Submana | TranslatedTitle
const pageTitle = `Submana | ${title}`;
---

<!doctype html>
<html lang={lang} data-theme={theme}>
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="Astro description" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/png" href="/icons/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg" />
    <link rel="shortcut icon" href="/icons/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png" />
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#8b5cf6" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="generator" content={Astro.generator} />
    <ClientRouter />
    <title>{pageTitle}</title>
    <script is:inline>
      (function() {
        const getTheme = () => localStorage.getItem('submana-theme') || 'dark';
        
        const applyTheme = (doc) => {
          const theme = getTheme();
          doc.documentElement.setAttribute('data-theme', theme);
        };

        // Initial apply to prevent any potential flash if server/client mismatch
        applyTheme(document);
        
        // Re-apply on every view transition
        document.addEventListener('astro:before-swap', (ev) => applyTheme(ev.newDocument));
        document.addEventListener('astro:after-swap', () => applyTheme(document));

        // Dynamic Title Localization Helper
        window.updateDocumentTitle = (translatedPageName) => {
          document.title = `Submana | ${translatedPageName}`;
        };

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js').catch(err => {
              console.log('SW registration failed: ', err);
            });
          });
        }
        
        // ── Fix for Swipe-to-Back Glitch ──
        // Disables Astro's view transition animation when the user navigates via history 
        // (swipe back/forward), letting the browser's native preview handle it seamlessly.
        document.addEventListener('astro:before-preparation', event => {
          if (event.navigationType === 'traverse') {
            document.documentElement.classList.add('no-view-transition');
          }
        });
        document.addEventListener('astro:after-swap', () => {
          document.documentElement.classList.remove('no-view-transition');
        });

      })();
    </script>
  </head>
  <body data-astro-prefetch>
    {Astro.url.pathname !== "/login" && <Navigation transition:persist />}
    <slot />
    <Toaster position="top-center" theme={theme === "light" ? "light" : "dark"} client:load />
  </body>
</html>
<style is:global>
  /* ═══════════════════════════════════════════════
     SUBMANA — Design Tokens
     Professional • Minimal • Premium
     ═══════════════════════════════════════════════ */

  /* ── Dark theme (default) ── */
  :root,
  [data-theme="dark"] {

    /* ── Surface & Neutrals ──
       Base neutra con matiz frío sutil (cool undertone) 
       para un aspecto premium y sofisticado              */
    --negro:          #0f1012;
    --gris-oscuro:    #18191c;
    --gris:           #26282d;
    --gris-claro:     #6b7280;
    --gris-muy-claro: #9ca3af;
    --blanco:         #f0f1f3;

    /* ── Accent · Purple ──
       Violeta como color principal de marca.
       Variantes para hover, soft backgrounds y texto sutil */
    --accent:         #8b5cf6;
    --accent-hover:   #7c3aed;
    --accent-soft:    rgba(139, 92, 246, 0.12);
    --accent-muted:   rgba(139, 92, 246, 0.25);

    /* ── Semantic · Success (Ingresos) ──
       Verde esmeralda equilibrado, no demasiado brillante */
    --success:        #34d399;
    --success-hover:  #10b981;
    --success-soft:   rgba(52, 211, 153, 0.12);
    --success-muted:  rgba(52, 211, 153, 0.25);

    /* ── Semantic · Danger (Gastos) ──
       Rojo coral suave, premium, no agresivo             */
    --danger:         #f87171;
    --danger-hover:   #ef4444;
    --danger-soft:    rgba(248, 113, 113, 0.12);
    --danger-muted:   rgba(248, 113, 113, 0.25);

    /* ── Semantic · Warning ──
       Ámbar cálido para alertas y estados pendientes     */
    --warning:        #fbbf24;
    --warning-hover:  #f59e0b;
    --warning-soft:   rgba(251, 191, 36, 0.12);
    --warning-muted:  rgba(251, 191, 36, 0.25);

    /* ── Semantic · Info ──
       Azul sereno para información y acciones neutrales  */
    --info:           #60a5fa;
    --info-hover:     #3b82f6;
    --info-soft:      rgba(96, 165, 250, 0.12);
    --info-muted:     rgba(96, 165, 250, 0.25);

    /* ── Utility · Teal ──
       Turquesa para tags, badges o categorías extra      */
    --teal:           #2dd4bf;
    --teal-hover:     #14b8a6;
    --teal-soft:      rgba(45, 212, 191, 0.12);

    /* ── Legacy aliases (retrocompatibilidad) ── */
    --naranja:        var(--warning);
    --azul:           var(--info);
    --rojo:           var(--danger);
    --rojo-oscuro:    var(--danger-hover);
  }

  /* ── Light theme ── */
  html[data-theme="light"] {

    /* ── Surface & Neutrals ──
       Fondo cálido con ligero matiz frío para limpieza   */
    --negro:          #f8f9fb;
    --gris-oscuro:    #eef0f4;
    --gris:           #dde1e8;
    --gris-claro:     #6b7280;
    --gris-muy-claro: #4b5563;
    --blanco:         #111318;

    /* ── Accent · Purple ──
       Ligeramente más oscuro para buen contraste en light */
    --accent:         #6d28d9;
    --accent-hover:   #5b21b6;
    --accent-soft:    rgba(109, 40, 217, 0.1);
    --accent-muted:   rgba(109, 40, 217, 0.2);

    /* ── Semantic · Success ── */
    --success:        #059669;
    --success-hover:  #047857;
    --success-soft:   rgba(5, 150, 105, 0.08);
    --success-muted:  rgba(5, 150, 105, 0.18);

    /* ── Semantic · Danger ── */
    --danger:         #dc2626;
    --danger-hover:   #b91c1c;
    --danger-soft:    rgba(220, 38, 38, 0.08);
    --danger-muted:   rgba(220, 38, 38, 0.18);

    /* ── Semantic · Warning ── */
    --warning:        #d97706;
    --warning-hover:  #b45309;
    --warning-soft:   rgba(217, 119, 6, 0.08);
    --warning-muted:  rgba(217, 119, 6, 0.18);

    /* ── Semantic · Info ── */
    --info:           #2563eb;
    --info-hover:     #1d4ed8;
    --info-soft:      rgba(37, 99, 235, 0.08);
    --info-muted:     rgba(37, 99, 235, 0.18);

    /* ── Utility · Teal ── */
    --teal:           #0d9488;
    --teal-hover:     #0f766e;
    --teal-soft:      rgba(13, 148, 136, 0.08);

    /* ── Legacy aliases ── */
    --naranja:        var(--warning);
    --azul:           var(--info);
    --rojo:           var(--danger);
    --rojo-oscuro:    var(--danger-hover);
  }

  html,
  body {
    margin: 0;
    padding: 0;
    min-height: 100dvh;
  }
  
  @media (min-width: 768px) {
    body {
      padding-left: 240px; /* Width of desktop sidebar */
    }
  }
  html {
    background: var(--negro);
    color: var(--blanco);
  }
  
  /* Smooth theme transition */
  html, body, div, section, nav, a, button, input, select, h1, h2, h3, h4, h5, h6, p, span {
    transition: background-color 0.3s ease, 
                color 0.3s ease, 
                border-color 0.3s ease, 
                box-shadow 0.3s ease;
  }

  * {
    font-family: "Sora", "Inter Variable", sans-serif;
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    -webkit-tap-highlight-color: transparent;
  }
  @font-face {
    font-family: "Sora";
    src: url("/fonts/Sora-VariableFont_wght.ttf") format("truetype");
    font-weight: 100 900;
    font-style: normal;
    font-display: swap;
  }
  .texto-largo {
    white-space: normal;
    overflow-wrap: break-word;
  }
  
  /* 
     Disable view transitions for history navigation (Swipe Back) 
     to prevent conflict with native browser gestures 
  */
  .no-view-transition::view-transition-group(*),
  .no-view-transition::view-transition-old(*),
  .no-view-transition::view-transition-new(*) {
    animation: none !important;
  }

  /* 
     Ensure the navigation stays visually above any view-transition-group 
     animations (e.g., subscription icon/name transitions floating on top) 
  */
  ::view-transition-group(nav-bar) {
    z-index: 9999;
  }

  /* ── Global Loading Spinner ── */
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  .loading-spinner {
      width: 1.25em;
      height: 1.25em;
      border: 2px solid currentColor;
      border-right-color: transparent;
      border-radius: 50%;
      animation: spin 0.75s linear infinite;
      display: inline-block;
      vertical-align: middle;
  }
  
  .btn-loading {
      position: relative;
      color: transparent !important;
      pointer-events: none;
      display: inline-flex !important;
      justify-content: center;
      align-items: center;
  }
  
  .btn-loading::after {
      content: "";
      position: absolute;
      width: 1.2em;
      height: 1.2em;
      border: 2px solid var(--blanco); /* Adaptive color */
      border-right-color: transparent;
      border-radius: 50%;
      animation: spin 0.75s linear infinite;
  }

  .submit-btn.btn-loading::after,
  .btn-save.btn-loading::after,
  .add-btn.btn-loading::after,
  .is-default.btn-loading::after {
      border-color: #ffffff;
      border-right-color: transparent;
  }

  /* ── Body Padding for Mobile Nav ── */
  @media (max-width: 767px) {
    body {
      padding-bottom: 100px; /* Ensure space for fixed bottom nav */
    }
  }
</style>
