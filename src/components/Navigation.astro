---
// Get current path to highlight active nav item
const pathname = new URL(Astro.request.url).pathname;
const currentPath = pathname === "/" ? pathname : pathname.replace(/\/$/, "");

import { getLangFromCookie, useTranslations } from "../i18n/utils";
const lang = getLangFromCookie(Astro.cookies);
const t = useTranslations(lang);
---

<nav class="navigation" id="main-nav">
  <!-- Desktop & Mobile Container -->
  <div class="nav-content">
    
    <!-- Logo for Desktop -->
    <div class="logo-container">
      <div class="logo-placeholder">
        <!-- SVG Logo Submana (Minimal version) -->
         <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="#8b5cf6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M2 17L12 22L22 17" stroke="#8b5cf6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M2 12L12 17L22 12" stroke="#8b5cf6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span class="logo-text">Submana</span>
      </div>
    </div>

    <!-- Navigation Items List -->
    <div class="nav-items-wrapper">
      
      <!-- Primary Items (Always visible on desktop, first 4 on mobile) -->
      <a href="/" class={`nav-item${currentPath === "/" ? " active" : ""}`}>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
        <span>{t('nav.home')}</span>
      </a>

      <a href="/subscriptions" class={`nav-item${currentPath === "/subscriptions" ? " active" : ""}`}>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
        <span>{t('nav.subscriptions')}</span>
      </a>

      <a href="/accounts" class={`nav-item extra-item${currentPath === "/accounts" ? " active" : ""}`}>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
        <span>{t('nav.accounts')}</span>
      </a>

      <a href="/expenses" class={`nav-item extra-item${currentPath === "/expenses" ? " active" : ""}`}>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>
        <span>{t('nav.expenses')}</span>
      </a>

      <!-- Secondary Items (Hidden in collapsed mobile view, shown in expanded/desktop) -->
      <a href="/notifications" class={`nav-item extra-item${currentPath === "/notifications" ? " active" : ""}`}>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
        <span>{t('nav.notifications')}</span>
      </a>

      <a href="/settings" class={`nav-item extra-item${currentPath === "/settings" ? " active" : ""}`}>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        <span>{t('nav.settings')}</span>
      </a>
      
      <!-- Mobile "More" Button -->
      <button class="nav-item more-btn" id="nav-toggle">
        <div class="icon-container">
          <!-- Menu Expand Icon (Chevrons Up) -->
          <svg class="icon-menu" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m17 11-5-5-5 5"/><path d="m17 18-5-5-5 5"/></svg>
          <!-- Close Icon (Initially Hidden) -->
          <svg class="icon-close" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
        </div>
        <span class="menu-text" data-menu={t('nav.menu')} data-close={t('nav.close')}>{t('nav.menu')}</span>
      </button>

    </div>
  </div>
</nav>

<div class="nav-backdrop" id="nav-backdrop"></div>

<script>
  const navToggle = document.getElementById('nav-toggle');
  const nav = document.getElementById('main-nav');
  const backdrop = document.getElementById('nav-backdrop');

  if (navToggle && nav) {
    navToggle.addEventListener('click', () => {
      const isExpanded = nav.classList.toggle('expanded');
      
      // Toggle Menu/Close text dynamically
      const menuText = navToggle.querySelector('.menu-text');
      if (menuText) {
        menuText.textContent = isExpanded 
          ? menuText.getAttribute('data-close') 
          : menuText.getAttribute('data-menu');
      }
    });

    if (backdrop) {
      backdrop.addEventListener('click', () => {
        nav.classList.remove('expanded');
        // Reset text
        const menuText = navToggle.querySelector('.menu-text');
        if (menuText) {
          menuText.textContent = menuText.getAttribute('data-menu');
        }
      });
    }
  }
  
  // Close when clicking a link
  const navLinks = nav?.querySelectorAll('.nav-item:not(.more-btn)');
  navLinks?.forEach(link => {
    link.addEventListener('click', () => {
      nav?.classList.remove('expanded');
    });
  });
</script>

<style>
  /* ─── Backdrop ─── */
  .nav-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(2px);
    z-index: 999999; /* Just below navigation (1000000) */
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease;
  }

  /* Show backdrop when nav is expanded */
  #main-nav.expanded ~ .nav-backdrop {
    opacity: 1;
    pointer-events: auto;
  }

  @media (min-width: 768px) {
    .nav-backdrop {
      display: none;
    }
  }

  /* ─── Base Navigation ─── */
  .navigation {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 1000000; /* Ensure it stays on top of FAB and modals */
    background-color: var(--negro); 
    
    /* Premium Top Border */
    border-top: 3px solid var(--accent);
    box-shadow: 0 -4px 20px -10px var(--accent-muted);
    
    /* Smooth expansion using height */
    height: 80px; /* Base mobile height */
    overflow: hidden;
    
    /* Unified transition for Opening/Closing - Fast & Smooth */
    transition: height 0.5s cubic-bezier(0.22, 1, 0.36, 1), 
                border-radius 0.5s cubic-bezier(0.22, 1, 0.36, 1),
                box-shadow 0.5s cubic-bezier(0.22, 1, 0.36, 1),
                background-color 0.3s ease;
  }

  .nav-content {
    max-width: 100%;
    margin: 0;
    position: relative;
    background-color: var(--negro);
    height: 100%;
  }

  /* ─── Mobile Layout (Default) ─── */
  .nav-items-wrapper {
    display: grid;
    /* 3 columns: Home, Subs, Menu */
    grid-template-columns: repeat(3, minmax(0, 1fr)); 
    align-items: center;
    padding: 0 0.5rem;
    height: 80px; /* Base height matches container */
    width: 100%;
  }

  /* Items styling */
  .nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.35rem;
    padding: 0.5rem 0; /* Removed horizontal padding to maximize text space */
    color: var(--gris-claro);
    text-decoration: none;
    border-radius: 12px;
    transition: all 0.2s ease;
    cursor: pointer;
    background: transparent;
    border: none;
    height: 100%;
    width: 100%;
    min-width: 0; /* Critical for grid text truncation */
  }

  .nav-item svg {
    width: 1.4rem;
    height: 1.4rem;
    stroke-width: 2px;
    transition: transform 0.2s ease, stroke 0.2s ease;
  }

  .nav-item span {
    font-size: 0.65rem; /* Slightly smaller to fit long words */
    letter-spacing: -0.03em; /* Tighter tracking */
    font-weight: 600;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
    width: 100%; /* Ensure it takes full width of container */
    padding: 0 2px; /* Tiny padding to prevent clipping at edges */
  }

  /* Hide extra items initially on mobile */
  .nav-item.extra-item {
    display: none; 
  }

  /* Active State */
  .nav-item.active {
    color: var(--accent);
  }
  
  .nav-item.active svg {
    stroke: var(--accent);
    filter: drop-shadow(0 0 6px var(--accent-muted));
  }

  /* ─── "More" Button Icons ─── */
  .more-btn .icon-container {
    position: relative;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .more-btn .icon-menu,
  .more-btn .icon-close {
    position: absolute;
    top: 0;
    left: 0;
    transition: all 0.3s ease;
  }
  
  .more-btn .icon-close {
    opacity: 0;
    transform: rotate(-90deg) scale(0.5);
  }

  /* ─── Mobile Expanded State ─── */
  .navigation.expanded {
    /* Expand upwards with fixed height for perfect transition symmetry */
    height: 280px; 
    border-radius: 24px 24px 0 0;
    box-shadow: 0 -10px 40px rgba(0,0,0,0.6);
  }

  .navigation.expanded .nav-items-wrapper {
    display: grid;
    /* Grid layout for expanded view - Strict equality */
    grid-template-columns: repeat(3, minmax(0, 1fr));
    grid-auto-rows: 90px; /* Taller items in grid */
    padding: 1.5rem 0.5rem; /* Reduced horizontal padding */
    height: auto;
    gap: 0.5rem; /* Reduced gap to give more width to items */
  }

  /* Show hidden items in expanded state */
  .navigation.expanded .nav-item.extra-item {
    display: flex;
  }

  .navigation.expanded .nav-item {
    background-color: var(--gris-oscuro);
    border: 1px solid var(--gris);
  }

  .navigation.expanded .nav-item.active {
    background-color: var(--accent-soft);
    border-color: var(--accent-muted);
  }

  /* Ocultar el botón de "More" cuando se expande el menú en móviles */
  .navigation.expanded .more-btn {
    display: none;
  }


  /* ─── Desktop Styles ─── */
  @media (min-width: 768px) {
    .navigation {
      top: 0;
      bottom: 0;
      left: 0;
      right: auto;
      width: 240px; /* Sidebar width */
      height: 100vh;
      overflow: visible; /* Reset mobile overflow */
      border-top: none;
      box-shadow: none; /* Remove mobile premium glow */
      border-right: 1px solid var(--gris);
      display: flex;
      flex-direction: column;
      padding: 1.5rem 1rem;
    }
    
    .logo-container {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem 0.75rem 2rem;
      margin-bottom: 1rem;
    }

    .logo-placeholder {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-text {
      font-size: 1.25rem;
      font-weight: 800;
      letter-spacing: -0.02em;
      color: var(--blanco);
    }
    
    .nav-items-wrapper {
      display: flex;
      flex-direction: column;
      height: auto;
      padding: 0;
      gap: 0.5rem;
    }

    .nav-item {
      flex-direction: row;
      justify-content: flex-start;
      gap: 1rem;
      padding: 0.85rem 1rem;
      width: 100%;
      height: auto;
      border-radius: 10px;
    }

    .nav-item span {
      font-size: 0.95rem;
      text-align: left;
    }

    .nav-item svg {
      width: 1.25rem;
      height: 1.25rem;
    }

    .nav-item:hover {
      background-color: var(--gris-oscuro);
      color: var(--blanco);
    }

    .nav-item.active {
      background-color: var(--accent-soft);
      border-right: 3px solid var(--accent); /* Right border indicator */
      border-radius: 8px 4px 4px 8px; /* Slightly different visual */
    }

    /* Show all items on desktop */
    .nav-item.extra-item {
      display: flex;
    }

    /* Hide mobile toggle */
    .more-btn {
      display: none;
    }
  }

  /* Body Padding Fix for Mobile */
  @media (max-width: 767px) {
    :global(body) {
      padding-bottom: 100px; /* Ensure space for fixed bottom nav */
    }
    
    /* Hide Logo on Mobile Navigation Bar */
    .logo-container {
      display: none;
    }
  }
</style>
