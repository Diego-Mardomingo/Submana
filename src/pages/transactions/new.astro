
---
import Layout from "../../layouts/Layout.astro";
import { supabase } from "../../lib/supabase";
import { getLangFromCookie, useTranslations } from "../../i18n/utils";

const { cookies, redirect } = Astro;
const lang = getLangFromCookie(cookies);
const t = useTranslations(lang);

const accessToken = cookies.get("sb-access-token");
const refreshToken = cookies.get("sb-refresh-token");

if (!accessToken || !refreshToken) {
  return redirect("/login");
}

let session;
try {
  session = await supabase.auth.setSession({
    refresh_token: refreshToken.value,
    access_token: accessToken.value,
  });
  if (session.error) {
    return redirect("/login");
  }
} catch (error) {
  return redirect("/login");
}

const user = session.data.user;

// Fetch Accounts
const { data: accounts } = await supabase
  .from("accounts")
  .select("id, name, is_default")
  .eq("user_id", user.id)
  .order("name");

// Fetch Categories
const { data: categories } = await supabase
  .from("categories")
  .select("id, name, parent_id")
  .eq("user_id", user.id)
  .order("name");

// Handle Edit Mode
const { id } = Astro.params;
const editMode = !!id;
let transactionData = null;

if (editMode) {
  const { data, error } = await supabase
    .from('transactions')
    .select('*')
    .eq('id', id)
    .single();
    
  if (!error) transactionData = data;
}

const accountsList = accounts || [];
const categoriesList = categories || [];

---

<Layout title={editMode ? t('transactions.edit') : t('transactions.add')}>
  <div class="page-container">
    <nav class="top-nav">
      <a href="/transactions" class="back-link">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
        <span>{t('nav.transactions')}</span>
      </a>
      <h1 class="page-title">{editMode ? t('transactions.edit') : t('transactions.add')}</h1>
    </nav>

    <main class="content-animate">
      <form method="post" action={editMode ? "/api/crud/update-transaction" : "/api/crud/create-transaction"} class="form-card" id="transaction-form">
        {editMode && <input type="hidden" name="id" value={id} />}
        
        <!-- Type Toggle Slider -->
        <div class="type-selector-container">
            <div class="type-slider" id="type-slider-bg"></div>
            <label class="type-option" for="type-expense">
                <input type="radio" name="type" id="type-expense" value="expense" checked={!transactionData || transactionData.type === 'expense'}>
                <span class="type-label">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline></svg>
                    {t('transactions.expense')}
                </span>
            </label>
            <label class="type-option" for="type-income">
                <input type="radio" name="type" id="type-income" value="income" checked={transactionData?.type === 'income'}>
                <span class="type-label">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
                    {t('transactions.income')}
                </span>
            </label>
        </div>

        <div class="form-section">
            <div class="field">
                <label for="amount">{t('common.amount')} (€)</label>
                <div class="currency-input">
                  <span class="currency-symbol">€</span>
                  <input type="number" id="amount" name="amount" placeholder="0.00" step="0.01" min="0" required autofocus value={transactionData?.amount} />
                </div>
            </div>

            <div class="field">
                <label for="date">{t('common.date')}</label>
                <input type="date" id="date" name="date" required value={transactionData?.date || new Date().toISOString().split('T')[0]} />
            </div>
        </div>

        <div class="field">
            <label for="description">{t('common.description')}</label>
            <input type="text" id="description" name="description" placeholder="Lunch, Salary, etc." autocomplete="off" value={transactionData?.description} />
        </div>
        
        <div class="divider"></div>

        <div class="form-section">
            <div class="field">
                <label for="account_id">{t('common.account')}</label>
                <select id="account_id" name="account_id" required>
                    {accountsList.map(acc => (
                        <option value={acc.id} selected={transactionData?.account_id === acc.id || (!transactionData && acc.is_default)}>{acc.name}</option>
                    ))}
                    {accountsList.length === 0 && <option value="" disabled selected>No accounts created</option>}
                </select>
                {accountsList.length === 0 && <a href="/accounts" class="helper-link">Create Account first</a>}
            </div>

            <div class="field">
                <label for="parent_category">{t('common.category')}</label>
                <select id="parent_category">
                    <option value="">Select Category</option>
                    {/* Populated by JS */}
                </select>
            </div>

             <div class="field hidden" id="sub-field">
                <label for="category_id">Subcategory</label>
                <select id="category_id" name="category_id">
                    <option value="">Select Subcategory</option>
                </select>
            </div>
            
            <input type="hidden" name="category_id" id="final_category_id">
        </div>

        <div class="form-actions">
           <button type="submit" class="submit-btn">
             {editMode ? t('common.save') : t('transactions.add')}
           </button>
        </div>

      </form>
    </main>
  </div>
</Layout>

<script define:vars={{ categoriesList, transactionData }}>
  // Pass categories to client
  const categories = categoriesList;
  
  function initForm() {
      const parentSelect = document.getElementById('parent_category');
      const subSelect = document.getElementById('category_id');
      const subField = document.getElementById('sub-field');
      const finalCategoryInput = document.getElementById('final_category_id');

      function updateParentOptions() {
          parentSelect.innerHTML = '<option value="">Select Category</option>';
          const parents = categories.filter(c => !c.parent_id);
          
          parents.forEach(p => {
              const option = document.createElement('option');
              option.value = p.id;
              option.textContent = p.name;
              parentSelect.appendChild(option);
          });
          
          // Reset sub
          subSelect.innerHTML = '<option value="">Select Subcategory</option>';
          subField.classList.add('hidden');
          finalCategoryInput.value = '';
      }

      function updateSubOptions(parentId) {
          subSelect.innerHTML = '<option value="">Select Subcategory</option>';
          const subs = categories.filter(c => c.parent_id === parentId);
          
          if (subs.length > 0) {
              subs.forEach(s => {
                  const option = document.createElement('option');
                  option.value = s.id;
                  option.textContent = s.name;
                  subSelect.appendChild(option);
              });
              subField.classList.remove('hidden');
          } else {
              subField.classList.add('hidden');
          }
      }


      parentSelect.addEventListener('change', (e) => {
          const parentId = e.target.value;
          if (parentId) {
              updateSubOptions(parentId);
              finalCategoryInput.value = parentId; // Default to parent if no sub selected
          } else {
              finalCategoryInput.value = '';
              subField.classList.add('hidden');
          }
      });

      subSelect.addEventListener('change', (e) => {
          const subId = e.target.value;
          if (subId) {
              finalCategoryInput.value = subId;
          } else {
              finalCategoryInput.value = parentSelect.value; // Revert to parent
          }
      });

      // Init
      updateParentOptions();

      // Pre-select category if editing
      if (transactionData?.category_id) {
          // Check if it is a parent or sub
          const isParent = categories.some(c => c.id === transactionData.category_id && !c.parent_id);
          
          if (isParent) {
              parentSelect.value = transactionData.category_id;
              finalCategoryInput.value = transactionData.category_id;
              updateSubOptions(transactionData.category_id);
          } else {
              // must be sub
              const sub = categories.find(c => c.id === transactionData.category_id);
              if (sub) {
                  parentSelect.value = sub.parent_id;
                  updateSubOptions(sub.parent_id);
                  subSelect.value = sub.id;
                  subField.classList.remove('hidden');
                  finalCategoryInput.value = sub.id;
              }
          }
      }

      // Slider Logic
      const expenseRadio = document.getElementById('type-expense');
      const incomeRadio = document.getElementById('type-income');
      const sliderBg = document.getElementById('type-slider-bg');

      function updateSlider() {
          if (incomeRadio.checked) {
              sliderBg.classList.add('is-income');
          } else {
              sliderBg.classList.remove('is-income');
          }
      }

      expenseRadio.addEventListener('change', updateSlider);
      incomeRadio.addEventListener('change', updateSlider);
      updateSlider(); // Initial state

      // Handle Loading
      const form = document.getElementById('transaction-form');
      if (form) {
          form.addEventListener('submit', (e) => {
             const btn = form.querySelector('button[type="submit"]');
             if(btn) {
                 if (btn.classList.contains('btn-loading')) {
                     e.preventDefault();
                     return false;
                 }
                 btn.classList.add('btn-loading');
             }
          });
      }
  }

  document.addEventListener('astro:page-load', initForm);
</script>

<style>
  .page-container {
    max-width: 600px;
    margin: 0 auto;
    padding: 1rem 1rem 8rem;
  }
  
  .content-animate {
      animation: slideUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
  }
  
  @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
  }

  /* Navigation */
  .top-nav {
      margin-bottom: 2rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
  }
  
  .page-title {
      font-size: 1.75rem;
      font-weight: 800;
      color: var(--blanco);
      margin: 0;
  }
  
  .back-link {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--gris-claro);
      text-decoration: none;
      font-weight: 600;
  }
  
  .back-link:hover { color: var(--blanco); }

  /* Form Card */
  .form-card {
      background: var(--gris-oscuro);
      border: 1px solid var(--gris);
      border-radius: 16px;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
  }

  /* Type Toggle Slider */
  .type-selector-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      background: var(--gris);
      padding: 0.25rem;
      border-radius: 14px;
      gap: 0;
      position: relative;
      height: 48px;
      isolation: isolate;
  }
  
  .type-slider {
      position: absolute;
      top: 0.25rem;
      left: 0.25rem;
      width: calc(50% - 0.25rem);
      height: calc(100% - 0.5rem);
      background: var(--rojo);
      border-radius: 12px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: -1;
      box-shadow: 0 4px 12px rgba(255, 68, 68, 0.3);
  }
  .type-slider.is-income {
      transform: translateX(100%);
      background: #10b981;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
  }
  
  .type-option {
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
  }
  
  .type-option input {
      display: none;
  }
  
  .type-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 700;
      font-size: 0.9rem;
      color: var(--gris-claro);
      transition: color 0.3s;
      text-transform: uppercase;
      letter-spacing: 0.05em;
  }
  
  input:checked + .type-label {
      color: white;
  }

  /* Fields */
  .form-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
  }
  
  @media(max-width: 500px) {
      .form-section { grid-template-columns: 1fr; }
  }

  .field {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
  }
  
  label {
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--gris-claro);
      text-transform: uppercase;
      letter-spacing: 0.05em;
  }
  
  input, select {
      background: var(--gris-oscuro);
      border: 1px solid var(--gris);
      color: var(--blanco);
      padding: 0.85rem;
      border-radius: 10px;
      font-size: 1rem;
      width: 100%;
      outline: none;
      transition: border-color 0.2s;
  }
  
  input:focus, select:focus {
      border-color: var(--accent);
  }

  .currency-input {
      position: relative;
  }
  
  .currency-symbol {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gris-claro);
      font-weight: 700;
  }
  
  .currency-input input {
      padding-left: 2.2rem;
  }

  .divider {
      height: 1px;
      background: var(--gris);
      opacity: 0.3;
  }
  
  .hidden {
      display: none;
  }
  
  .helper-link {
      font-size: 0.8rem;
      color: var(--accent);
      text-decoration: underline;
      margin-top: 0.25rem;
      display: block;
  }

  /* Actions */
  .submit-btn {
      width: 100%;
      background: var(--accent);
      color: white;
      border: none;
      padding: 1rem;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 15px rgba(var(--accent-rgb), 0.3);
  }
  
  .submit-btn:hover {
      background: var(--accent-hover);
      transform: translateY(-2px);
  }

</style>
