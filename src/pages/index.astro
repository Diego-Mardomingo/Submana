---
import Layout from '../layouts/Layout.astro';
import { supabase } from '../lib/supabase';

// const prerender = false

const { cookies, redirect } = Astro;

const accessToken = cookies.get("sb-access-token");
const refreshToken = cookies.get("sb-refresh-token");

if(!accessToken || !refreshToken){
	return redirect("/login");
}


let session;
try {
	session = await supabase.auth.setSession(
		{
			refresh_token: refreshToken.value,
			access_token: accessToken.value,
		}
	);
	if(session.error){
		resetCookies();
	}
} catch (error) {
	resetCookies();
}

const email = session.data.user?.email;


function resetCookies(){
	cookies.delete("sb-access-token",{path: "/"});
	cookies.delete("sb-refresh-token",{path: "/"});
	console.log('Cookies reseteadas');
	return redirect("/login")
}

---


<Layout title="MyPlayground">
	<div style="color: white;">
		<h1>Bienvenido, {email}.</h1>
		<p>Estamos contentos de verte de nuevo.</p>
		<form action="/api/auth/signout">
			<button type="submit">Sign out</button>
		</form>
	</div>
</Layout>

