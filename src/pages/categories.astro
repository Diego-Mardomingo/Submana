---
import Layout from "../layouts/Layout.astro";
import { supabase } from "../lib/supabase";
import CategoriesBody from "../components/CategoriesBody";
import { getLangFromCookie, useTranslations } from "../i18n/utils";

const { cookies, redirect } = Astro;
const lang = getLangFromCookie(cookies);
const t = useTranslations(lang);

const accessToken = cookies.get("sb-access-token");
const refreshToken = cookies.get("sb-refresh-token");

if (!accessToken || !refreshToken) {
  return redirect("/login");
}

Astro.response.headers.set("Cache-Control", "no-cache, no-store, must-revalidate");
Astro.response.headers.set("Pragma", "no-cache");
Astro.response.headers.set("Expires", "0");

let session;
try {
  session = await supabase.auth.setSession({
    refresh_token: refreshToken.value,
    access_token: accessToken.value,
  });
  if (session.error) {
    cookies.delete("sb-access-token", { path: "/" });
    cookies.delete("sb-refresh-token", { path: "/" });
    return redirect("/login");
  }
} catch (error) {
  cookies.delete("sb-access-token", { path: "/" });
  cookies.delete("sb-refresh-token", { path: "/" });
  return redirect("/login");
}
---

<Layout title={t('categories.title')}>
  <CategoriesBody lang={lang} client:only="react" />
</Layout>
