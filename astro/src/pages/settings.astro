---
import Layout from "../layouts/Layout.astro";
import SettingsBody from "../components/SettingsBody";
import { getLangFromCookie, useTranslations } from "../i18n/utils";

import { supabase } from "../lib/supabase";

const { cookies, redirect } = Astro;
const lang = getLangFromCookie(cookies);
const t = useTranslations(lang);

const accessToken = cookies.get("sb-access-token");
const refreshToken = cookies.get("sb-refresh-token");

if (!accessToken || !refreshToken) {
  return redirect("/login");
}

let user = null;
try {
  const { data, error } = await supabase.auth.getUser(accessToken.value);
  if (error || !data.user) {
     // Optional: try refreshing session if really needed, but usually access token is enough for getUser
     // If failing, redirect to login
     return redirect("/login");
  }
  user = data.user;
} catch (e) {
  return redirect("/login");
}

Astro.response.headers.set("Cache-Control", "no-cache, no-store, must-revalidate");
Astro.response.headers.set("Pragma", "no-cache");
Astro.response.headers.set("Expires", "0");
---

<Layout title={t('nav.settings')}>
  <SettingsBody 
    lang={lang} 
    user={user}
    client:only="react" 
    supabaseUrl={import.meta.env.SUPABASE_URL} 
    supabaseKey={import.meta.env.SUPABASE_KEY} 
  />
</Layout>
